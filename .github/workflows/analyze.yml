name: Learning Path Analysis CI/CD

on:
  schedule:
    # –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 00:00 UTC
    - cron: '0 0 * * 1'
  
  workflow_dispatch:
    inputs:
      dataset:
        description: 'Dataset to analyze'
        required: true
        default: 'sample'
        type: choice
        options:
          - sample
          - full
      generate_report:
        description: 'Generate HTML report'
        required: true
        default: true
        type: boolean
  
  push:
    branches: [ main, develop ]
  
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov black
    
    - name: Format with black
      run: |
        black src/ tests/
    
    - name: Lint with flake8
      run: |
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Run tests with pytest
      run: |
        pytest tests/ -v --cov=src --cov-report=xml --cov-report=html
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          htmlcov/
  
  analyze:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Prepare data directory
      run: |
        mkdir -p data
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
        if [ ! -f "data/sample_log.csv" ]; then
          echo "‚ùå No data file found. Analysis will be skipped."
          echo "SKIP_ANALYSIS=true" >> $GITHUB_ENV
        else
          echo "‚úÖ Data file found: data/sample_log.csv"
          echo "SKIP_ANALYSIS=false" >> $GITHUB_ENV
        fi
    
    - name: Run analysis
      if: env.SKIP_ANALYSIS == 'false'
      run: |
        echo "Running learning path analysis..."
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª
        INPUT_FILE="data/sample_log.csv"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
        python main.py \
          --input $INPUT_FILE \
          --output reports/ \
          --config config.yaml
        
        echo "Analysis completed!"
    
    - name: Skip analysis message
      if: env.SKIP_ANALYSIS == 'true'
      run: |
        echo "‚è≠Ô∏è Analysis skipped - no data file available"
        mkdir -p reports
        echo "<html><body><h1>Analysis Skipped</h1><p>No data file available. Please add data/sample_log.csv to run analysis.</p></body></html>" > reports/index.html
    
    - name: Generate summary report
      run: |
        echo "# üìä Learning Path Analysis Results" > analysis_summary.md
        echo "" >> analysis_summary.md
        if [ "$SKIP_ANALYSIS" = "true" ]; then
          echo "**Analysis was skipped due to missing data file**" >> analysis_summary.md
        else
          echo "**Analysis completed successfully!**" >> analysis_summary.md
        fi
        echo "" >> analysis_summary.md
        echo "## üìà Key Metrics" >> analysis_summary.md
        echo "" >> analysis_summary.md
        echo "- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> analysis_summary.md
        echo "- Workflow: ${{ github.workflow }}" >> analysis_summary.md
        echo "- Trigger: ${{ github.event_name }}" >> analysis_summary.md
        echo "- Commit: ${{ github.sha }}" >> analysis_summary.md
        echo "- Analysis Status: $([ "$SKIP_ANALYSIS" = "true" ] && echo "Skipped" || echo "Completed")" >> analysis_summary.md
        echo "" >> analysis_summary.md
        echo "## üìÅ Generated Files" >> analysis_summary.md
        echo "" >> analysis_summary.md
        echo "The following files were generated:" >> analysis_summary.md
        echo "" >> analysis_summary.md
        ls -la reports/ >> analysis_summary.md
    
    - name: Upload analysis artifacts
      uses: actions/upload-artifact@v4
      with:
        name: analysis-reports
        path: |
          reports/
          analysis_summary.md
        retention-days: 30
  
  deploy:
    runs-on: ubuntu-latest
    needs: [test, analyze]
    # –î–æ–±–∞–≤–ª—è–µ–º permissions –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    permissions:
      contents: write
      pages: write
      id-token: write
    # –£—Å–ª–æ–≤–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏ –∏ –ø—É—à–∞ (–Ω–µ PR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    # –î–æ–±–∞–≤–ª—è–µ–º environment –¥–ª—è GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç—ã –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–ª—è Pages
        path: './reports'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
  
  notify:
    runs-on: ubuntu-latest
    # –û–°–¢–û–†–û–ñ–ù–û: –£–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ jobs, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è
    needs: [test, analyze]
    if: always()
    
    steps:
    - name: Create workflow summary
      run: |
        echo "# üéì Learning Path Analyzer - Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üìä Job Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Job**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Analysis Job**: ${{ needs.analyze.result }}" >> $GITHUB_STEP_SUMMARY
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω deploy job
        DEPLOY_STATUS="${{ needs.deploy.result }}"
        if [ -n "$DEPLOY_STATUS" ]; then
          echo "- **Deploy Job**: $DEPLOY_STATUS" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üìÅ Artifacts Generated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Test coverage reports" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Analysis reports and visualizations" >> $GITHUB_STEP_SUMMARY
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è
        if [ -n "$DEPLOY_STATUS" ] && [ "$DEPLOY_STATUS" = "success" ]; then
          echo "‚úÖ Reports deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "üåê URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
        fi