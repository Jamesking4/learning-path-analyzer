name: Learning Path Analysis CI/CD

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 00:00 UTC
    - cron: '0 0 * * 1'
  
  workflow_dispatch:
    inputs:
      dataset:
        description: 'Dataset to analyze'
        required: true
        default: 'sample'
        type: choice
        options:
          - sample
          - full
      generate_report:
        description: 'Generate HTML report'
        required: true
        default: true
        type: boolean
  
  push:
    branches: [ main, develop ]
  
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Lint with flake8
      run: |
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Format check with black
      run: |
        black --check src/ tests/
    
    - name: Run tests with pytest
      run: |
        pytest tests/ -v --cov=src --cov-report=xml --cov-report=html
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
    
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          htmlcov/
          test-results.xml
  
  analyze:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Generate sample data (if needed)
      run: |
        python generate_sample_data.py
    
    - name: Run analysis
      id: analysis
      run: |
        echo "Running learning path analysis..."
        
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð²Ñ…Ð¾Ð´Ð½Ð¾Ð¹ Ñ„Ð°Ð¹Ð» Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°
        if [ "${{ github.event.inputs.dataset }}" = "full" ]; then
          INPUT_FILE="data/sample_large_log.csv"
        else
          INPUT_FILE="data/sample_log.csv"
        fi
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð°Ð½Ð°Ð»Ð¸Ð·
        python main.py \
          --input $INPUT_FILE \
          --output reports/ \
          --config config.yaml
        
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿ÑƒÑ‚ÑŒ Ðº Ð¾Ñ‚Ñ‡ÐµÑ‚Ñƒ
        echo "report_path=reports/analysis_report.html" >> $GITHUB_OUTPUT
    
    - name: Generate summary report
      if: ${{ github.event.inputs.generate_report == 'true' || github.event_name == 'schedule' }}
      run: |
        echo "# ðŸ“Š Learning Path Analysis Results" > analysis_summary.md
        echo "" >> analysis_summary.md
        echo "**Analysis completed successfully!**" >> analysis_summary.md
        echo "" >> analysis_summary.md
        echo "## ðŸ“ˆ Key Metrics" >> analysis_summary.md
        echo "" >> analysis_summary.md
        echo "- Dataset: ${{ github.event.inputs.dataset || 'sample' }}" >> analysis_summary.md
        echo "- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> analysis_summary.md
        echo "- Workflow: ${{ github.workflow }}" >> analysis_summary.md
        echo "- Trigger: ${{ github.event_name }}" >> analysis_summary.md
        echo "" >> analysis_summary.md
        echo "## ðŸ“ Generated Files" >> analysis_summary.md
        echo "" >> analysis_summary.md
        echo "The following files were generated:" >> analysis_summary.md
        echo "" >> analysis_summary.md
        ls -la reports/ >> analysis_summary.md
    
    - name: Commit and push report
      if: github.event_name == 'schedule'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹
        git add reports/
        git add analysis_summary.md
        
        # ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚ Ð¸ Ð¿ÑƒÑˆ
        git commit -m "ðŸ“ˆ Update analysis reports - $(date -u '+%Y-%m-%d')" || echo "No changes to commit"
        git push
    
    - name: Upload analysis artifacts
      uses: actions/upload-artifact@v3
      with:
        name: analysis-reports
        path: |
          reports/
          analysis_summary.md
        retention-days: 30
    
    - name: Deploy to GitHub Pages (optional)
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./reports
        destination_dir: ./reports
        keep_files: false
  
  notify:
    needs: [test, analyze]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Check workflow status
      id: check
      run: |
        if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.analyze.result }}" = "success" ]; then
          echo "status=âœ… All checks passed" >> $GITHUB_OUTPUT
        elif [ "${{ needs.test.result }}" = "failure" ] || [ "${{ needs.analyze.result }}" = "failure" ]; then
          echo "status=âŒ Some checks failed" >> $GITHUB_OUTPUT
        else
          echo "status=âš ï¸ Workflow completed with warnings" >> $GITHUB_OUTPUT
        fi
    
    - name: Create workflow summary
      run: |
        echo "# Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.check.outputs.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Job Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Job**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Analysis Job**: ${{ needs.analyze.result }}" >> $GITHUB_STEP_SUMMARY